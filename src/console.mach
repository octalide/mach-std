use std.types.option;
use std.types.string;
use std.types.result;
use std.types.size;

$if ($mach.build.target.os.id == $mach.os.linux.id) {
    use impl: std.console.linux;
}

$if ($mach.build.target.os.id == $mach.os.darwin.id) {
    use impl: std.console.darwin;
}

$if ($mach.build.target.os.id == $mach.os.windows.id) {
    use impl: std.console.windows;
}

pub val STDIN:  i32 = 0;
pub val STDOUT: i32 = 1;
pub val STDERR: i32 = 2;

fun write_segment(fd: i32, part: str) i64 {
    if (part.len == 0) {
        ret 0;
    }

    ret impl.write(fd, part.data, part.len);
}

pub fun write_to(fd: i32, pattern: str, ...) i64 {
    val extra: usize = va_count();
    if (extra == 0) {
        ret write_segment(fd, pattern);
    }

    val res: Option[String] = format(pattern, ...);
    if (res.is_none()) {
        ret -1;
    }

    var rendered: String = res.unwrap();
    if (rendered.len == 0) {
        rendered.dnit();
        ret 0;
    }

    val view: str = rendered.as_str();
    val wrote: i64 = write_segment(fd, view);
    rendered.dnit();

    ret wrote;
}

pub fun write(pattern: str, ...) i64 {
    ret write_to(STDOUT, pattern, ...);
}

pub fun print(pattern: str, ...) i64 {
    ret write_to(STDOUT, pattern, ...);
}

pub fun error(pattern: str, ...) i64 {
    ret write_to(STDERR, pattern, ...);
}

pub fun read_from(fd: i32, dest: *u8, max: usize) i64 {
    if (dest == nil || max == 0) {
        ret 0;
    }

    ret impl.read(fd, dest, max);
}

pub fun read(dest: *u8, max: usize) i64 {
    ret read_from(STDIN, dest, max);
}
